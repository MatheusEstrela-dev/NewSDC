version: '3.8'

services:
  jenkins:
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    container_name: jenkins_master
    restart: unless-stopped
    privileged: false  # Não usar privileged em produção
    ports:
      - "8080:8080"   # Interface Web
      - "50000:50000" # Agentes JNLP
    environment:
      # ===== CONFIGURAÇÕES DE TIMEZONE =====
      - TZ=America/Sao_Paulo

      # ===== CONFIGURAÇÕES CRÍTICAS DE MEMÓRIA (Resolve OOM Killer) =====
      # IMPORTANTE: Ajustar -Xmx para 75% da memória do container
      # Se mem_limit é 4GB, usar -Xmx3g
      - JAVA_OPTS=-Xms512m -Xmx3g -Djava.awt.headless=true -Djenkins.install.runSetupWizard=false -Dhudson.model.DirectoryBrowserSupport.CSP=""

      # ===== CONFIGURAÇÕES DE DOCKER =====
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DOCKER_GID=999  # GID do grupo docker no host (verificar com: getent group docker)

      # ===== CONFIGURAÇÕES DE REDE =====
      # Permite que builds acessem outros containers via nome
      - JENKINS_OPTS=--prefix=/jenkins

    volumes:
      # ===== VOLUME PERSISTENTE (Resolve problema de UID/GID) =====
      # CRÍTICO: A pasta jenkins_home DEVE ter permissões corretas
      # Executar antes: mkdir -p ./jenkins_home && chown -R 1000:1000 ./jenkins_home
      - ./jenkins_home:/var/jenkins_home

      # ===== ACESSO AO DOCKER DO HOST (Docker-outside-of-Docker) =====
      # Permite Jenkins construir imagens Docker
      - /var/run/docker.sock:/var/run/docker.sock:rw

      # ===== CACHE MAVEN/GRADLE (Acelera builds) =====
      - ./jenkins_cache/.m2:/var/jenkins_home/.m2
      - ./jenkins_cache/.gradle:/var/jenkins_home/.gradle

      # ===== SSH KEYS (Resolve problema de Git SSH) =====
      # As chaves SSH devem estar em jenkins_home/.ssh com permissões 600
      # - ./jenkins_ssh:/var/jenkins_home/.ssh:ro

    networks:
      - jenkins_network
      - sdc_network  # Conecta à rede da aplicação SDC

    deploy:
      resources:
        limits:
          cpus: '4'      # Máximo de 4 cores
          memory: 4G     # IMPORTANTE: Deve ser maior que -Xmx do JAVA_OPTS
        reservations:
          cpus: '2'
          memory: 2G

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 120s  # Jenkins demora para iniciar

    labels:
      - "com.jenkins.description=Jenkins CI/CD Master"
      - "com.jenkins.version=lts"

  # ===== AGENTE DOCKER DINÂMICO (Opcional mas recomendado) =====
  # Este container fica parado esperando jobs do Jenkins
  jenkins-agent-docker:
    image: jenkins/inbound-agent:latest-jdk17
    container_name: jenkins_agent_docker
    restart: unless-stopped
    environment:
      - JENKINS_URL=http://jenkins:8080
      - JENKINS_AGENT_NAME=docker-agent
      # A SECRET precisa ser gerada no Jenkins depois da primeira inicialização
      - JENKINS_SECRET=${JENKINS_AGENT_SECRET}
      - JENKINS_AGENT_WORKDIR=/home/jenkins/agent
    volumes:
      - ./jenkins_agent_workdir:/home/jenkins/agent
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - jenkins_network
    depends_on:
      - jenkins

  # ===== NGINX REVERSE PROXY (Produção com SSL) =====
  jenkins-nginx:
    image: nginx:alpine
    container_name: jenkins_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./jenkins/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./jenkins/ssl:/etc/nginx/ssl:ro  # Certificados SSL
      - ./jenkins/logs:/var/log/nginx
    networks:
      - jenkins_network
    depends_on:
      - jenkins
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ===== BACKUP AUTOMÁTICO =====
  jenkins-backup:
    image: alpine:latest
    container_name: jenkins_backup
    restart: unless-stopped
    volumes:
      - ./jenkins_home:/source:ro
      - ./jenkins_backups:/backups
    command: >
      sh -c "
      while true; do
        echo '[$(date)] Starting backup...'
        tar -czf /backups/jenkins_home_$(date +%Y%m%d_%H%M%S).tar.gz -C /source .
        # Mantém apenas os últimos 7 backups
        ls -t /backups/*.tar.gz | tail -n +8 | xargs -r rm
        echo '[$(date)] Backup completed'
        sleep 86400  # 24 horas
      done
      "
    networks:
      - jenkins_network

networks:
  jenkins_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

  # Conecta à rede existente do SDC
  sdc_network:
    external: true

volumes:
  jenkins_home:
    driver: local
  jenkins_agent_workdir:
    driver: local
