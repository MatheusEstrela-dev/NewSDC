# ============================================================================
# SDC - PRODUCTION DOCKERFILE
# Build otimizado para Azure App Service
# ============================================================================

FROM php:8.3-cli-alpine

LABEL maintainer="SDC Team"
LABEL environment="production"

# Instalar depend√™ncias
RUN apk add --no-cache \
    bash \
    curl \
    git \
    libpng \
    libjpeg-turbo \
    freetype \
    libwebp \
    oniguruma \
    libxml2 \
    libzip \
    postgresql-libs \
    icu-libs \
    && apk add --no-cache --virtual .build-deps \
    libpng-dev \
    libjpeg-turbo-dev \
    freetype-dev \
    libwebp-dev \
    oniguruma-dev \
    libxml2-dev \
    libzip-dev \
    postgresql-dev \
    icu-dev \
    linux-headers \
    $PHPIZE_DEPS

# Instalar extens√µes PHP
RUN docker-php-ext-configure gd \
    --with-freetype \
    --with-jpeg \
    --with-webp \
    && docker-php-ext-install -j$(nproc) \
    pdo_mysql \
    pdo_pgsql \
    mysqli \
    mbstring \
    exif \
    pcntl \
    bcmath \
    gd \
    zip \
    intl \
    opcache \
    && pecl install redis-6.0.2 \
    && docker-php-ext-enable redis \
    && apk del .build-deps

# Copiar Composer
COPY --from=composer:2.7 /usr/bin/composer /usr/bin/composer

# Instalar Node.js para compilar assets (tempor√°rio - ser√° removido ap√≥s build)
RUN apk add --no-cache nodejs npm

# Configura√ß√£o PHP
RUN cp "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini" \
    && echo "memory_limit=512M" > /usr/local/etc/php/conf.d/99-memory.ini

# Diret√≥rio de trabalho
WORKDIR /var/www

# Copiar arquivos de depend√™ncias primeiro (para cache do Docker)
COPY composer.json composer.lock* ./
COPY package.json package-lock.json* ./

# Verificar se composer.json existe
RUN test -f composer.json || (echo "ERRO: composer.json n√£o encontrado!" && ls -la && exit 1)

# Instalar depend√™ncias PHP (antes de copiar todo o c√≥digo - melhor cache)
RUN composer install \
    --no-dev \
    --no-interaction \
    --prefer-dist \
    --optimize-autoloader \
    --ignore-platform-reqs \
    --no-scripts || (echo "ERRO ao instalar depend√™ncias" && cat composer.json && exit 1)

# Instalar depend√™ncias Node.js (incluindo devDependencies para compilar assets)
RUN if [ -f package.json ]; then \
        npm ci --no-audit --no-fund || \
        (echo "‚ö†Ô∏è npm ci falhou, tentando npm install..." && npm install --no-audit --no-fund); \
    fi

# Copiar resto do c√≥digo da aplica√ß√£o
COPY . .

# Executar scripts do composer ap√≥s copiar c√≥digo
RUN composer dump-autoload --optimize --classmap-authoritative

# Compilar assets do Vite (CR√çTICO para aplica√ß√£o funcionar)
RUN if [ -f package.json ]; then \
        echo "üî® Compilando assets do Vite..." && \
        npm run build && \
        echo "‚úÖ Assets compilados com sucesso!" && \
        ls -la public/build/ || echo "‚ö†Ô∏è Diret√≥rio build n√£o encontrado"; \
    else \
        echo "‚ö†Ô∏è package.json n√£o encontrado, pulando build de assets"; \
    fi

# Remover Node.js e npm ap√≥s compilar assets (reduzir tamanho da imagem)
RUN apk del nodejs npm || true

# Criar diret√≥rios
RUN mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache \
    && chmod -R 775 storage bootstrap/cache

# Script de inicializa√ß√£o para App Service
COPY docker/scripts/entrypoint.prod.sh /start.sh
RUN chmod +x /start.sh

# Verificar que tudo est√° no lugar
RUN ls -la /var/www && \
    test -f /var/www/composer.json && \
    test -d /var/www/vendor && \
    echo "‚úÖ Build verificado: composer.json e vendor presentes"

# Expor porta
EXPOSE 8000

# Start
CMD ["/start.sh"]
