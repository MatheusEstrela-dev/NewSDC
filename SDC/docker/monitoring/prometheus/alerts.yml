# ============================================================================
# Prometheus Alert Rules - SDC
# ============================================================================

groups:
  - name: sdc_alerts
    interval: 30s
    rules:
      # Aplicação está down
      - alert: ApplicationDown
        expr: sdc_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "SDC Application is DOWN"
          description: "Application {{ $labels.instance }} has been down for more than 1 minute"

      # Alta taxa de erros
      - alert: HighErrorRate
        expr: rate(sdc_events_total{type="error"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors/second"

      # Muitos jobs pendentes na fila
      - alert: HighQueueBacklog
        expr: sdc_queue_jobs_pending > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High queue backlog"
          description: "Queue {{ $labels.queue }} has {{ $value }} pending jobs"

      # Alto uso de memória
      - alert: HighMemoryUsage
        expr: sdc_memory_usage_bytes > 1073741824  # 1GB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ humanize $value }} bytes"

      # Redis está down
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is DOWN"
          description: "Redis instance {{ $labels.instance }} is not responding"

      # MySQL está down
      - alert: MySQLDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL is DOWN"
          description: "MySQL instance {{ $labels.instance }} is not responding"

      # Alto uso de disco
      - alert: HighDiskUsage
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Disk space running low"
          description: "Less than 10% disk space available on {{ $labels.mountpoint }}"

      # Alta latência de requisições
      - alert: HighRequestLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High request latency"
          description: "95th percentile latency is {{ $value }}s"
