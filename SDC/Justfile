# ============================================================================
# SDC - Justfile para Gerenciamento de Banco de Dados
# Comandos facilitados para migrations, rollback, seeds e manutenÃ§Ã£o
# ============================================================================

# VariÃ¡veis de ambiente
compose := "docker compose -f docker/docker-compose.yml"
compose_prod := "docker compose -f docker/docker-compose.prod.yml"
app := compose + " exec app"
app_prod := compose_prod + " exec app"
db := compose + " exec db"
db_prod := compose_prod + " exec db"

# Define ambiente padrÃ£o (dev ou prod)
env := env_var_or_default("ENV", "dev")

# Escolhe comando baseado no ambiente
_app := if env == "prod" { app_prod } else { app }
_db := if env == "prod" { db_prod } else { db }
_compose := if env == "prod" { compose_prod } else { compose }

# ============================================================================
# ğŸ“‹ HELP & INFO
# ============================================================================

# Lista todos os comandos disponÃ­veis (default)
@default:
    just --list

# Mostra ajuda detalhada com exemplos
help:
    @echo "ğŸ—„ï¸  SDC - Gerenciamento de Banco de Dados"
    @echo ""
    @echo "ğŸ“š CATEGORIAS:"
    @echo "  Migrations   - Criar, executar e reverter migrations"
    @echo "  Seeds        - Popular banco com dados"
    @echo "  Backup       - Backup e restore"
    @echo "  ManutenÃ§Ã£o   - Otimizar, reparar e limpar"
    @echo "  InformaÃ§Ãµes  - Status e estatÃ­sticas"
    @echo ""
    @echo "ğŸ¯ USO:"
    @echo "  just <comando>              # Desenvolvimento"
    @echo "  ENV=prod just <comando>     # ProduÃ§Ã£o"
    @echo ""
    @echo "ğŸ“– EXEMPLOS:"
    @echo "  just migrate                # Executar migrations pendentes"
    @echo "  just rollback 3             # Reverter Ãºltimas 3 migrations"
    @echo "  just fresh                  # Resetar banco com seeds"
    @echo "  just backup manual          # Criar backup manual"
    @echo "  ENV=prod just status        # Ver status em produÃ§Ã£o"
    @echo ""
    @echo "ğŸ’¡ TIP: Use 'just --list' para ver todos os comandos"

# Mostra informaÃ§Ãµes do ambiente atual
info:
    @echo "ğŸ” INFORMAÃ‡Ã•ES DO AMBIENTE"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Ambiente:      {{env}}"
    @echo "Docker Compose: {{_compose}}"
    @echo "Container App:  {{_app}}"
    @echo "Container DB:   {{_db}}"
    @echo ""
    {{_compose}} ps

# ============================================================================
# ğŸ”„ MIGRATIONS
# ============================================================================

# Executar migrations pendentes
migrate:
    @echo "ğŸ”„ Executando migrations..."
    {{_app}} php artisan migrate --force
    @echo "âœ… Migrations concluÃ­das!"

# Executar APENAS as migrations do sistema de permissionamento (v2.0)
migrate-permissions:
    @echo "ğŸ” Executando migrations do sistema de permissionamento..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "ğŸ“‹ Migrations incluÃ­das:"
    @echo "  - 2025_12_10_000001_create_roles_table.php"
    @echo "  - 2025_12_10_000002_create_permissions_table.php"
    @echo "  - 2025_12_10_000003_create_role_user_table.php"
    @echo "  - 2025_12_10_000004_create_permission_role_table.php"
    @echo "  - 2025_12_23_000001_create_permission_audit_log_table.php"
    @echo ""
    {{_app}} php artisan migrate --path=database/migrations/2025_12_10_000001_create_roles_table.php --force
    {{_app}} php artisan migrate --path=database/migrations/2025_12_10_000002_create_permissions_table.php --force
    {{_app}} php artisan migrate --path=database/migrations/2025_12_10_000003_create_role_user_table.php --force
    {{_app}} php artisan migrate --path=database/migrations/2025_12_10_000004_create_permission_role_table.php --force
    {{_app}} php artisan migrate --path=database/migrations/2025_12_23_000001_create_permission_audit_log_table.php --force
    @echo ""
    @echo "âœ… Migrations de permissionamento concluÃ­das!"
    @echo ""
    @echo "ğŸ’¡ PrÃ³ximos passos:"
    @echo "  1. Execute: just seed-permissions"
    @echo "  2. Limpe o cache: just cache-clear"
    @echo "  3. Verifique: just permissions-status"

# Executar migrations com output detalhado
migrate-verbose:
    @echo "ğŸ”„ Executando migrations (verbose)..."
    {{_app}} php artisan migrate --force -vvv

# Verificar status das migrations (quais jÃ¡ foram executadas)
migrate-status:
    @echo "ğŸ“Š Status das Migrations:"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    {{_app}} php artisan migrate:status

# Criar nova migration
migrate-create name:
    @echo "ğŸ“ Criando migration: {{name}}"
    {{_app}} php artisan make:migration {{name}}
    @echo "âœ… Migration criada em database/migrations/"

# Criar migration para tabela especÃ­fica
migrate-table name table:
    @echo "ğŸ“ Criando migration para tabela: {{table}}"
    {{_app}} php artisan make:migration {{name}} --create={{table}}
    @echo "âœ… Migration criada!"

# Modificar tabela existente
migrate-modify name table:
    @echo "ğŸ“ Criando migration para modificar: {{table}}"
    {{_app}} php artisan make:migration {{name}} --table={{table}}
    @echo "âœ… Migration criada!"

# ============================================================================
# â®ï¸ ROLLBACK
# ============================================================================

# Reverter Ãºltima batch de migrations
rollback:
    @echo "â®ï¸  Revertendo Ãºltima batch de migrations..."
    {{_app}} php artisan migrate:rollback --force
    @echo "âœ… Rollback concluÃ­do!"

# Reverter N batches de migrations
rollback-steps steps:
    @echo "â®ï¸  Revertendo {{steps}} batches de migrations..."
    {{_app}} php artisan migrate:rollback --step={{steps}} --force
    @echo "âœ… Rollback de {{steps}} batches concluÃ­do!"

# Reverter TODAS as migrations
rollback-all:
    @echo "âš ï¸  ATENÃ‡ÃƒO: Revertendo TODAS as migrations!"
    @echo "Pressione Ctrl+C para cancelar..."
    sleep 3
    {{_app}} php artisan migrate:reset --force
    @echo "âœ… Todas as migrations revertidas!"

# Reverter e executar novamente Ãºltima batch
migrate-refresh:
    @echo "ğŸ”„ Refresh da Ãºltima batch..."
    {{_app}} php artisan migrate:refresh --force
    @echo "âœ… Refresh concluÃ­do!"

# Reverter e executar novamente N batches
migrate-refresh-steps steps:
    @echo "ğŸ”„ Refresh de {{steps}} batches..."
    {{_app}} php artisan migrate:refresh --step={{steps}} --force
    @echo "âœ… Refresh de {{steps}} batches concluÃ­do!"

# ============================================================================
# ğŸŒ± SEEDS
# ============================================================================

# Executar todos os seeders
seed:
    @echo "ğŸŒ± Executando seeders..."
    {{_app}} php artisan db:seed --force
    @echo "âœ… Seeds concluÃ­dos!"

# Executar seeder especÃ­fico
seed-class class:
    @echo "ğŸŒ± Executando seeder: {{class}}"
    {{_app}} php artisan db:seed --class={{class}} --force
    @echo "âœ… Seeder {{class}} concluÃ­do!"

# Executar seeder de roles e permissions
seed-permissions:
    @echo "ğŸ” Populando roles e permissions..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    {{_app}} php artisan db:seed --class=RolesAndPermissionsSeeder --force
    @echo ""
    @echo "âœ… Roles e permissions criados!"
    @echo ""
    @echo "ğŸ“Š Resumo:"
    just permissions-count

# Criar novo seeder
seed-create name:
    @echo "ğŸ“ Criando seeder: {{name}}"
    {{_app}} php artisan make:seeder {{name}}
    @echo "âœ… Seeder criado em database/seeders/"

# ============================================================================
# ğŸ”¥ FRESH (PERIGOSO!)
# ============================================================================

# Dropar tudo, recriar e popular (DESENVOLVIMENTO)
fresh:
    @echo "ğŸ”¥ ATENÃ‡ÃƒO: Dropando TODAS as tabelas!"
    @echo "Ambiente: {{env}}"
    @echo "Pressione Ctrl+C para cancelar..."
    sleep 3
    {{_app}} php artisan migrate:fresh --seed --force
    @echo "âœ… Banco de dados resetado com seeds!"

# Fresh sem seeds
fresh-no-seed:
    @echo "ğŸ”¥ Dropando e recriando banco (sem seeds)..."
    {{_app}} php artisan migrate:fresh --force
    @echo "âœ… Banco de dados resetado!"

# Fresh em PRODUÃ‡ÃƒO (requer confirmaÃ§Ã£o dupla)
fresh-prod:
    @echo "ğŸš¨ PERIGO: FRESH EM PRODUÃ‡ÃƒO! ğŸš¨"
    @echo "Isso irÃ¡ DELETAR TODOS OS DADOS!"
    @echo ""
    @read -p "Digite 'CONFIRMO' para continuar: " confirm; \
    if [ "$$confirm" != "CONFIRMO" ]; then \
        echo "âŒ Cancelado!"; exit 1; \
    fi
    @echo "Ãšltima chance! Pressione Ctrl+C..."
    sleep 5
    ENV=prod {{_app_prod}} php artisan migrate:fresh --seed --force
    @echo "âœ… ProduÃ§Ã£o resetada!"

# ============================================================================
# ğŸ’¾ BACKUP & RESTORE
# ============================================================================

# Criar backup manual do banco de dados
backup name="manual":
    @echo "ğŸ’¾ Criando backup: {{name}}"
    mkdir -p storage/backups
    {{_db}} mysqldump -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE > storage/backups/backup-{{name}}-$(date +%Y%m%d-%H%M%S).sql
    @echo "âœ… Backup criado em storage/backups/"

# Criar backup antes de migration arriscada
backup-before-migrate:
    @echo "ğŸ’¾ Criando backup de seguranÃ§a..."
    just backup "pre-migration"
    @echo "ğŸ”„ Executando migrations..."
    just migrate

# Listar backups disponÃ­veis
backup-list:
    @echo "ğŸ“‹ Backups DisponÃ­veis:"
    @ls -lh storage/backups/*.sql 2>/dev/null || echo "Nenhum backup encontrado"

# Restaurar backup especÃ­fico
backup-restore file:
    @echo "âš ï¸  ATENÃ‡ÃƒO: Restaurando backup!"
    @echo "Arquivo: {{file}}"
    @echo "Isso irÃ¡ SOBRESCREVER o banco atual!"
    @echo "Pressione Ctrl+C para cancelar..."
    sleep 3
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE < {{file}}
    @echo "âœ… Backup restaurado!"

# Criar backup automÃ¡tico (para cron)
backup-auto:
    #!/usr/bin/env bash
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    BACKUP_DIR="storage/backups"
    mkdir -p $BACKUP_DIR

    echo "ğŸ’¾ Backup automÃ¡tico: $TIMESTAMP"
    {{_db}} mysqldump -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE > $BACKUP_DIR/backup-auto-$TIMESTAMP.sql

    # Manter apenas Ãºltimos 7 backups
    ls -t $BACKUP_DIR/backup-auto-*.sql | tail -n +8 | xargs -r rm
    echo "âœ… Backup concluÃ­do e rotacionado!"

# ============================================================================
# ğŸ”§ MANUTENÃ‡ÃƒO
# ============================================================================

# Otimizar todas as tabelas
optimize:
    @echo "âš¡ Otimizando tabelas..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; OPTIMIZE TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… OtimizaÃ§Ã£o concluÃ­da!"

# Reparar tabelas corrompidas
repair:
    @echo "ğŸ”§ Reparando tabelas..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; REPAIR TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… Reparo concluÃ­do!"

# Analisar tabelas
analyze:
    @echo "ğŸ“Š Analisando tabelas..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; ANALYZE TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… AnÃ¡lise concluÃ­da!"

# Verificar integridade das tabelas
check:
    @echo "ğŸ” Verificando integridade..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; CHECK TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… VerificaÃ§Ã£o concluÃ­da!"

# Limpar cache do Laravel
cache-clear:
    @echo "ğŸ§¹ Limpando caches do Laravel..."
    {{_app}} php artisan cache:clear
    {{_app}} php artisan config:clear
    {{_app}} php artisan route:clear
    {{_app}} php artisan view:clear
    @echo "âœ… Caches limpos!"

# Otimizar para produÃ§Ã£o
cache-optimize:
    @echo "âš¡ Otimizando caches para produÃ§Ã£o..."
    {{_app}} php artisan config:cache
    {{_app}} php artisan route:cache
    {{_app}} php artisan view:cache
    {{_app}} php artisan event:cache
    @echo "âœ… OtimizaÃ§Ã£o concluÃ­da!"

# ============================================================================
# ğŸ“Š INFORMAÃ‡Ã•ES & STATUS
# ============================================================================

# Ver status completo do banco de dados
status:
    @echo "ğŸ“Š STATUS DO BANCO DE DADOS"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "ğŸ”„ Migrations:"
    just migrate-status
    @echo ""
    @echo "ğŸ’¾ Tamanho do Banco:"
    just db-size
    @echo ""
    @echo "ğŸ“‹ Tabelas:"
    just tables

# Listar todas as tabelas
tables:
    @echo "ğŸ“‹ Tabelas no Banco:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; SHOW TABLES;"

# Contar registros de todas as tabelas
count:
    @echo "ğŸ”¢ Contagem de Registros:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT table_name AS 'Tabela', table_rows AS 'Registros' FROM information_schema.tables WHERE table_schema = '$$MYSQL_DATABASE' ORDER BY table_rows DESC;"

# Ver tamanho do banco de dados
db-size:
    @echo "ğŸ’¾ Tamanho do Banco de Dados:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "SELECT table_schema AS 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' FROM information_schema.tables WHERE table_schema = '$$MYSQL_DATABASE' GROUP BY table_schema;"

# Ver tamanho de cada tabela
table-sizes:
    @echo "ğŸ“Š Tamanho das Tabelas:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT table_name AS 'Tabela', ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)' FROM information_schema.TABLES WHERE table_schema = '$$MYSQL_DATABASE' ORDER BY (data_length + index_length) DESC;"

# Descrever estrutura de uma tabela
describe table:
    @echo "ğŸ“‹ Estrutura da Tabela: {{table}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "DESCRIBE {{table}};"

# Ver Ã­ndices de uma tabela
indexes table:
    @echo "ğŸ”‘ Ãndices da Tabela: {{table}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SHOW INDEXES FROM {{table}};"

# ============================================================================
# ğŸš ACESSO DIRETO
# ============================================================================

# Acesso direto ao MySQL CLI
mysql:
    @echo "ğŸš Acessando MySQL CLI..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE

# Executar query SQL direta
query sql:
    @echo "ğŸ” Executando query..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "{{sql}}"

# Acesso ao shell do container app
shell:
    @echo "ğŸš Acessando shell do container..."
    {{_compose}} exec app bash

# Acesso ao shell do container db
db-shell:
    @echo "ğŸš Acessando shell do banco..."
    {{_compose}} exec db bash

# ============================================================================
# ğŸ§ª TESTES
# ============================================================================

# Executar migrations no banco de testes
test-migrate:
    @echo "ğŸ§ª Executando migrations no banco de testes..."
    {{_app}} php artisan migrate --database=testing --force
    @echo "âœ… Migrations de teste concluÃ­das!"

# Resetar banco de testes
test-fresh:
    @echo "ğŸ§ª Resetando banco de testes..."
    {{_app}} php artisan migrate:fresh --database=testing --seed --force
    @echo "âœ… Banco de testes resetado!"

# ============================================================================
# ğŸš€ WORKFLOWS COMPLETOS
# ============================================================================

# Setup inicial completo do banco
setup:
    @echo "ğŸš€ SETUP INICIAL DO BANCO DE DADOS"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    just migrate
    just seed
    just cache-optimize
    @echo ""
    @echo "âœ… Setup concluÃ­do!"
    just status

# Deploy seguro em produÃ§Ã£o
deploy:
    @echo "ğŸš€ DEPLOY EM PRODUÃ‡ÃƒO"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "1. Criando backup..."
    ENV=prod just backup "pre-deploy"
    @echo ""
    @echo "2. Executando migrations..."
    ENV=prod just migrate
    @echo ""
    @echo "3. Otimizando caches..."
    ENV=prod just cache-optimize
    @echo ""
    @echo "âœ… Deploy concluÃ­do!"
    ENV=prod just status

# ManutenÃ§Ã£o completa do banco
maintenance:
    @echo "ğŸ”§ MANUTENÃ‡ÃƒO COMPLETA"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    just backup "pre-maintenance"
    just check
    just analyze
    just optimize
    just cache-optimize
    @echo ""
    @echo "âœ… ManutenÃ§Ã£o concluÃ­da!"
    just db-size

# DiagnÃ³stico completo
diagnose:
    @echo "ğŸ” DIAGNÃ“STICO COMPLETO"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    just info
    @echo ""
    just status
    @echo ""
    just table-sizes
    @echo ""
    just count
    @echo ""
    @echo "âœ… DiagnÃ³stico concluÃ­do!"

# ============================================================================
# ğŸ—‘ï¸ LIMPEZA (PERIGOSO!)
# ============================================================================

# Dropar banco e recriar do zero
nuke:
    @echo "ğŸ’£ ATENÃ‡ÃƒO: DESTRUINDO BANCO DE DADOS!"
    @echo "Ambiente: {{env}}"
    @echo "Isso Ã© IRREVERSÃVEL!"
    @echo ""
    @read -p "Digite 'DESTRUIR' para confirmar: " confirm; \
    if [ "$$confirm" != "DESTRUIR" ]; then \
        echo "âŒ Cancelado!"; exit 1; \
    fi
    @echo ""
    @echo "Ãšltima chance! Pressione Ctrl+C..."
    sleep 5
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "DROP DATABASE IF EXISTS $$MYSQL_DATABASE; CREATE DATABASE $$MYSQL_DATABASE;"
    just migrate
    @echo "âœ… Banco recriado do zero!"

# ============================================================================
# ğŸ” SISTEMA DE PERMISSIONAMENTO (v2.0)
# ============================================================================

# Status completo do sistema de permissionamento
permissions-status:
    @echo "ğŸ” STATUS DO SISTEMA DE PERMISSIONAMENTO"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "ğŸ“Š Contadores:"
    just permissions-count
    @echo ""
    @echo "ğŸ‘¥ Roles por Hierarquia:"
    just permissions-roles
    @echo ""
    @echo "ğŸ”‘ Permissions por MÃ³dulo:"
    just permissions-by-module
    @echo ""
    @echo "ğŸ“ Logs de Auditoria (Ãºltimos 10):"
    just permissions-audit

# Contar roles, permissions e usuÃ¡rios
permissions-count:
    @echo "ğŸ“Š Contadores do Sistema:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT 'Roles' AS Tipo, COUNT(*) AS Total FROM roles WHERE is_active = 1 UNION ALL SELECT 'Permissions' AS Tipo, COUNT(*) AS Total FROM permissions WHERE is_active = 1 UNION ALL SELECT 'Users' AS Tipo, COUNT(*) AS Total FROM users WHERE email_verified_at IS NOT NULL UNION ALL SELECT 'Role Assignments' AS Tipo, COUNT(*) AS Total FROM role_user UNION ALL SELECT 'Audit Logs' AS Tipo, COUNT(*) AS Total FROM permission_audit_log;"

# Listar todos os roles
permissions-roles:
    @echo "ğŸ‘¥ Roles Cadastrados:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT id, name AS 'Nome', slug AS 'Slug', hierarchy_level AS 'NÃ­vel', is_active AS 'Ativo', (SELECT COUNT(*) FROM role_user WHERE role_id = roles.id) AS 'UsuÃ¡rios' FROM roles ORDER BY hierarchy_level;"

# Listar permissions por mÃ³dulo
permissions-by-module:
    @echo "ğŸ”‘ Permissions por MÃ³dulo:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT COALESCE(module, 'general') AS 'MÃ³dulo', COUNT(*) AS 'Total', SUM(CASE WHEN is_active = 1 THEN 1 ELSE 0 END) AS 'Ativas', SUM(CASE WHEN is_immutable = 1 THEN 1 ELSE 0 END) AS 'ImutÃ¡veis' FROM permissions GROUP BY module ORDER BY Total DESC;"

# Listar permissions de um mÃ³dulo especÃ­fico
permissions-module module:
    @echo "ğŸ”‘ Permissions do MÃ³dulo: {{module}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT id, name AS 'Nome', slug AS 'Slug', description AS 'DescriÃ§Ã£o', is_active AS 'Ativo', is_immutable AS 'ImutÃ¡vel' FROM permissions WHERE module = '{{module}}' ORDER BY name;"

# Ver Ãºltimos logs de auditoria
permissions-audit limit="10":
    @echo "ğŸ“ Ãšltimos {{limit}} Logs de Auditoria:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT pal.id, u.name AS 'UsuÃ¡rio', pal.action AS 'AÃ§Ã£o', pal.entity_type AS 'Entidade', pal.entity_id AS 'ID', pal.ip_address AS 'IP', DATE_FORMAT(pal.created_at, '%Y-%m-%d %H:%i:%s') AS 'Data/Hora' FROM permission_audit_log pal LEFT JOIN users u ON pal.user_id = u.id ORDER BY pal.created_at DESC LIMIT {{limit}};"

# Ver logs de auditoria de um usuÃ¡rio especÃ­fico
permissions-audit-user user_id:
    @echo "ğŸ“ Logs de Auditoria do UsuÃ¡rio: {{user_id}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT id, action AS 'AÃ§Ã£o', entity_type AS 'Entidade', entity_id AS 'ID', ip_address AS 'IP', DATE_FORMAT(created_at, '%Y-%m-%d %H:%i:%s') AS 'Data/Hora' FROM permission_audit_log WHERE user_id = {{user_id}} ORDER BY created_at DESC LIMIT 20;"

# Ver permissions de um role especÃ­fico
permissions-role role_slug:
    @echo "ğŸ”‘ Permissions do Role: {{role_slug}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT p.id, p.name AS 'Permission', p.slug AS 'Slug', p.module AS 'MÃ³dulo' FROM permissions p INNER JOIN permission_role pr ON p.id = pr.permission_id INNER JOIN roles r ON pr.role_id = r.id WHERE r.slug = '{{role_slug}}' ORDER BY p.module, p.name;"

# Ver roles de um usuÃ¡rio especÃ­fico
permissions-user user_id:
    @echo "ğŸ‘¤ Roles do UsuÃ¡rio: {{user_id}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT r.id, r.name AS 'Role', r.slug AS 'Slug', r.hierarchy_level AS 'NÃ­vel', DATE_FORMAT(ru.created_at, '%Y-%m-%d %H:%i:%s') AS 'AtribuÃ­do em' FROM roles r INNER JOIN role_user ru ON r.id = ru.role_id WHERE ru.user_id = {{user_id}} ORDER BY r.hierarchy_level;"

# Verificar integridade do sistema de permissionamento
permissions-check:
    @echo "ğŸ” VERIFICAÃ‡ÃƒO DE INTEGRIDADE"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "1. Verificando tabelas..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT 'OK' AS Status FROM roles LIMIT 1;" > /dev/null 2>&1 && echo "  âœ… Tabela 'roles' existe" || echo "  âŒ Tabela 'roles' nÃ£o encontrada"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT 'OK' AS Status FROM permissions LIMIT 1;" > /dev/null 2>&1 && echo "  âœ… Tabela 'permissions' existe" || echo "  âŒ Tabela 'permissions' nÃ£o encontrada"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT 'OK' AS Status FROM role_user LIMIT 1;" > /dev/null 2>&1 && echo "  âœ… Tabela 'role_user' existe" || echo "  âŒ Tabela 'role_user' nÃ£o encontrada"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT 'OK' AS Status FROM permission_role LIMIT 1;" > /dev/null 2>&1 && echo "  âœ… Tabela 'permission_role' existe" || echo "  âŒ Tabela 'permission_role' nÃ£o encontrada"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT 'OK' AS Status FROM permission_audit_log LIMIT 1;" > /dev/null 2>&1 && echo "  âœ… Tabela 'permission_audit_log' existe" || echo "  âŒ Tabela 'permission_audit_log' nÃ£o encontrada"
    @echo ""
    @echo "2. Verificando integridade referencial..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT COUNT(*) AS 'Roles Ã³rfÃ£os' FROM role_user ru LEFT JOIN roles r ON ru.role_id = r.id WHERE r.id IS NULL;"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT COUNT(*) AS 'Users Ã³rfÃ£os' FROM role_user ru LEFT JOIN users u ON ru.user_id = u.id WHERE u.id IS NULL;"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT COUNT(*) AS 'Permissions Ã³rfÃ£s' FROM permission_role pr LEFT JOIN permissions p ON pr.permission_id = p.id WHERE p.id IS NULL;"
    @echo ""
    @echo "âœ… VerificaÃ§Ã£o concluÃ­da!"

# Setup completo do sistema de permissionamento
permissions-setup:
    @echo "ğŸš€ SETUP DO SISTEMA DE PERMISSIONAMENTO v2.0"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "1ï¸âƒ£  Criando backup..."
    just backup "pre-permissions-setup"
    @echo ""
    @echo "2ï¸âƒ£  Executando migrations..."
    just migrate-permissions
    @echo ""
    @echo "3ï¸âƒ£  Populando roles e permissions..."
    just seed-permissions
    @echo ""
    @echo "4ï¸âƒ£  Limpando caches..."
    just cache-clear
    @echo ""
    @echo "5ï¸âƒ£  Verificando integridade..."
    just permissions-check
    @echo ""
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "âœ… SETUP CONCLUÃDO COM SUCESSO!"
    @echo ""
    @echo "ğŸ“Š Status Final:"
    just permissions-status

# DocumentaÃ§Ã£o do sistema de permissionamento
permissions-docs:
    @echo "ğŸ“š DOCUMENTAÃ‡ÃƒO DO SISTEMA DE PERMISSIONAMENTO"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "ğŸ“„ Documentos DisponÃ­veis:"
    @echo "  - Doc/PERMISSION_SYSTEM_ARCHITECTURE.md"
    @echo "  - Doc/RESUMO_EXECUTIVO_PERMISSIONAMENTO.md"
    @echo ""
    @echo "ğŸ”§ Comandos DisponÃ­veis:"
    @echo "  just permissions-setup          # Setup completo"
    @echo "  just permissions-status         # Ver status"
    @echo "  just permissions-check          # Verificar integridade"
    @echo "  just migrate-permissions        # Executar migrations"
    @echo "  just seed-permissions           # Popular dados"
    @echo "  just permissions-roles          # Listar roles"
    @echo "  just permissions-by-module      # Listar por mÃ³dulo"
    @echo "  just permissions-audit          # Ver logs auditoria"
    @echo ""
    @echo "ğŸ“Š Consultas EspecÃ­ficas:"
    @echo "  just permissions-role <slug>    # Permissions de um role"
    @echo "  just permissions-user <id>      # Roles de um usuÃ¡rio"
    @echo "  just permissions-module <mod>   # Permissions de um mÃ³dulo"
    @echo ""
    @echo "ğŸ“– Para mais informaÃ§Ãµes, consulte a documentaÃ§Ã£o completa."
