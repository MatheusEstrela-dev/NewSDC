# ============================================================================
# SDC - Justfile para Gerenciamento de Banco de Dados
# Comandos facilitados para migrations, rollback, seeds e manutenÃ§Ã£o
# ============================================================================

# VariÃ¡veis de ambiente
compose := "docker compose -f docker/docker-compose.yml"
compose_prod := "docker compose -f docker/docker-compose.prod.yml"
app := compose + " exec app"
app_prod := compose_prod + " exec app"
db := compose + " exec db"
db_prod := compose_prod + " exec db"

# Define ambiente padrÃ£o (dev ou prod)
env := env_var_or_default("ENV", "dev")

# Escolhe comando baseado no ambiente
_app := if env == "prod" { app_prod } else { app }
_db := if env == "prod" { db_prod } else { db }
_compose := if env == "prod" { compose_prod } else { compose }

# ============================================================================
# ğŸ“‹ HELP & INFO
# ============================================================================

# Lista todos os comandos disponÃ­veis (default)
@default:
    just --list

# Mostra ajuda detalhada com exemplos
help:
    @echo "ğŸ—„ï¸  SDC - Gerenciamento de Banco de Dados"
    @echo ""
    @echo "ğŸ“š CATEGORIAS:"
    @echo "  Migrations   - Criar, executar e reverter migrations"
    @echo "  Seeds        - Popular banco com dados"
    @echo "  Backup       - Backup e restore"
    @echo "  ManutenÃ§Ã£o   - Otimizar, reparar e limpar"
    @echo "  InformaÃ§Ãµes  - Status e estatÃ­sticas"
    @echo ""
    @echo "ğŸ¯ USO:"
    @echo "  just <comando>              # Desenvolvimento"
    @echo "  ENV=prod just <comando>     # ProduÃ§Ã£o"
    @echo ""
    @echo "ğŸ“– EXEMPLOS:"
    @echo "  just migrate                # Executar migrations pendentes"
    @echo "  just rollback 3             # Reverter Ãºltimas 3 migrations"
    @echo "  just fresh                  # Resetar banco com seeds"
    @echo "  just backup manual          # Criar backup manual"
    @echo "  ENV=prod just status        # Ver status em produÃ§Ã£o"
    @echo ""
    @echo "ğŸ’¡ TIP: Use 'just --list' para ver todos os comandos"

# Mostra informaÃ§Ãµes do ambiente atual
info:
    @echo "ğŸ” INFORMAÃ‡Ã•ES DO AMBIENTE"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Ambiente:      {{env}}"
    @echo "Docker Compose: {{_compose}}"
    @echo "Container App:  {{_app}}"
    @echo "Container DB:   {{_db}}"
    @echo ""
    {{_compose}} ps

# ============================================================================
# ğŸ”„ MIGRATIONS
# ============================================================================

# Executar migrations pendentes
migrate:
    @echo "ğŸ”„ Executando migrations..."
    {{_app}} php artisan migrate --force
    @echo "âœ… Migrations concluÃ­das!"

# Executar migrations com output detalhado
migrate-verbose:
    @echo "ğŸ”„ Executando migrations (verbose)..."
    {{_app}} php artisan migrate --force -vvv

# Verificar status das migrations (quais jÃ¡ foram executadas)
migrate-status:
    @echo "ğŸ“Š Status das Migrations:"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    {{_app}} php artisan migrate:status

# Criar nova migration
migrate-create name:
    @echo "ğŸ“ Criando migration: {{name}}"
    {{_app}} php artisan make:migration {{name}}
    @echo "âœ… Migration criada em database/migrations/"

# Criar migration para tabela especÃ­fica
migrate-table name table:
    @echo "ğŸ“ Criando migration para tabela: {{table}}"
    {{_app}} php artisan make:migration {{name}} --create={{table}}
    @echo "âœ… Migration criada!"

# Modificar tabela existente
migrate-modify name table:
    @echo "ğŸ“ Criando migration para modificar: {{table}}"
    {{_app}} php artisan make:migration {{name}} --table={{table}}
    @echo "âœ… Migration criada!"

# ============================================================================
# â®ï¸ ROLLBACK
# ============================================================================

# Reverter Ãºltima batch de migrations
rollback:
    @echo "â®ï¸  Revertendo Ãºltima batch de migrations..."
    {{_app}} php artisan migrate:rollback --force
    @echo "âœ… Rollback concluÃ­do!"

# Reverter N batches de migrations
rollback-steps steps:
    @echo "â®ï¸  Revertendo {{steps}} batches de migrations..."
    {{_app}} php artisan migrate:rollback --step={{steps}} --force
    @echo "âœ… Rollback de {{steps}} batches concluÃ­do!"

# Reverter TODAS as migrations
rollback-all:
    @echo "âš ï¸  ATENÃ‡ÃƒO: Revertendo TODAS as migrations!"
    @echo "Pressione Ctrl+C para cancelar..."
    sleep 3
    {{_app}} php artisan migrate:reset --force
    @echo "âœ… Todas as migrations revertidas!"

# Reverter e executar novamente Ãºltima batch
migrate-refresh:
    @echo "ğŸ”„ Refresh da Ãºltima batch..."
    {{_app}} php artisan migrate:refresh --force
    @echo "âœ… Refresh concluÃ­do!"

# Reverter e executar novamente N batches
migrate-refresh-steps steps:
    @echo "ğŸ”„ Refresh de {{steps}} batches..."
    {{_app}} php artisan migrate:refresh --step={{steps}} --force
    @echo "âœ… Refresh de {{steps}} batches concluÃ­do!"

# ============================================================================
# ğŸŒ± SEEDS
# ============================================================================

# Executar todos os seeders
seed:
    @echo "ğŸŒ± Executando seeders..."
    {{_app}} php artisan db:seed --force
    @echo "âœ… Seeds concluÃ­dos!"

# Executar seeder especÃ­fico
seed-class class:
    @echo "ğŸŒ± Executando seeder: {{class}}"
    {{_app}} php artisan db:seed --class={{class}} --force
    @echo "âœ… Seeder {{class}} concluÃ­do!"

# Criar novo seeder
seed-create name:
    @echo "ğŸ“ Criando seeder: {{name}}"
    {{_app}} php artisan make:seeder {{name}}
    @echo "âœ… Seeder criado em database/seeders/"

# ============================================================================
# ğŸ”¥ FRESH (PERIGOSO!)
# ============================================================================

# Dropar tudo, recriar e popular (DESENVOLVIMENTO)
fresh:
    @echo "ğŸ”¥ ATENÃ‡ÃƒO: Dropando TODAS as tabelas!"
    @echo "Ambiente: {{env}}"
    @echo "Pressione Ctrl+C para cancelar..."
    sleep 3
    {{_app}} php artisan migrate:fresh --seed --force
    @echo "âœ… Banco de dados resetado com seeds!"

# Fresh sem seeds
fresh-no-seed:
    @echo "ğŸ”¥ Dropando e recriando banco (sem seeds)..."
    {{_app}} php artisan migrate:fresh --force
    @echo "âœ… Banco de dados resetado!"

# Fresh em PRODUÃ‡ÃƒO (requer confirmaÃ§Ã£o dupla)
fresh-prod:
    @echo "ğŸš¨ PERIGO: FRESH EM PRODUÃ‡ÃƒO! ğŸš¨"
    @echo "Isso irÃ¡ DELETAR TODOS OS DADOS!"
    @echo ""
    @read -p "Digite 'CONFIRMO' para continuar: " confirm; \
    if [ "$$confirm" != "CONFIRMO" ]; then \
        echo "âŒ Cancelado!"; exit 1; \
    fi
    @echo "Ãšltima chance! Pressione Ctrl+C..."
    sleep 5
    ENV=prod {{_app_prod}} php artisan migrate:fresh --seed --force
    @echo "âœ… ProduÃ§Ã£o resetada!"

# ============================================================================
# ğŸ’¾ BACKUP & RESTORE
# ============================================================================

# Criar backup manual do banco de dados
backup name="manual":
    @echo "ğŸ’¾ Criando backup: {{name}}"
    mkdir -p storage/backups
    {{_db}} mysqldump -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE > storage/backups/backup-{{name}}-$(date +%Y%m%d-%H%M%S).sql
    @echo "âœ… Backup criado em storage/backups/"

# Criar backup antes de migration arriscada
backup-before-migrate:
    @echo "ğŸ’¾ Criando backup de seguranÃ§a..."
    just backup "pre-migration"
    @echo "ğŸ”„ Executando migrations..."
    just migrate

# Listar backups disponÃ­veis
backup-list:
    @echo "ğŸ“‹ Backups DisponÃ­veis:"
    @ls -lh storage/backups/*.sql 2>/dev/null || echo "Nenhum backup encontrado"

# Restaurar backup especÃ­fico
backup-restore file:
    @echo "âš ï¸  ATENÃ‡ÃƒO: Restaurando backup!"
    @echo "Arquivo: {{file}}"
    @echo "Isso irÃ¡ SOBRESCREVER o banco atual!"
    @echo "Pressione Ctrl+C para cancelar..."
    sleep 3
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE < {{file}}
    @echo "âœ… Backup restaurado!"

# Criar backup automÃ¡tico (para cron)
backup-auto:
    #!/usr/bin/env bash
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    BACKUP_DIR="storage/backups"
    mkdir -p $BACKUP_DIR

    echo "ğŸ’¾ Backup automÃ¡tico: $TIMESTAMP"
    {{_db}} mysqldump -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE > $BACKUP_DIR/backup-auto-$TIMESTAMP.sql

    # Manter apenas Ãºltimos 7 backups
    ls -t $BACKUP_DIR/backup-auto-*.sql | tail -n +8 | xargs -r rm
    echo "âœ… Backup concluÃ­do e rotacionado!"

# ============================================================================
# ğŸ”§ MANUTENÃ‡ÃƒO
# ============================================================================

# Otimizar todas as tabelas
optimize:
    @echo "âš¡ Otimizando tabelas..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; OPTIMIZE TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… OtimizaÃ§Ã£o concluÃ­da!"

# Reparar tabelas corrompidas
repair:
    @echo "ğŸ”§ Reparando tabelas..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; REPAIR TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… Reparo concluÃ­do!"

# Analisar tabelas
analyze:
    @echo "ğŸ“Š Analisando tabelas..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; ANALYZE TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… AnÃ¡lise concluÃ­da!"

# Verificar integridade das tabelas
check:
    @echo "ğŸ” Verificando integridade..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; CHECK TABLE $({{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -Nse 'SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=\"$$MYSQL_DATABASE\"');"
    @echo "âœ… VerificaÃ§Ã£o concluÃ­da!"

# Limpar cache do Laravel
cache-clear:
    @echo "ğŸ§¹ Limpando caches do Laravel..."
    {{_app}} php artisan cache:clear
    {{_app}} php artisan config:clear
    {{_app}} php artisan route:clear
    {{_app}} php artisan view:clear
    @echo "âœ… Caches limpos!"

# Otimizar para produÃ§Ã£o
cache-optimize:
    @echo "âš¡ Otimizando caches para produÃ§Ã£o..."
    {{_app}} php artisan config:cache
    {{_app}} php artisan route:cache
    {{_app}} php artisan view:cache
    {{_app}} php artisan event:cache
    @echo "âœ… OtimizaÃ§Ã£o concluÃ­da!"

# ============================================================================
# ğŸ“Š INFORMAÃ‡Ã•ES & STATUS
# ============================================================================

# Ver status completo do banco de dados
status:
    @echo "ğŸ“Š STATUS DO BANCO DE DADOS"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "ğŸ”„ Migrations:"
    just migrate-status
    @echo ""
    @echo "ğŸ’¾ Tamanho do Banco:"
    just db-size
    @echo ""
    @echo "ğŸ“‹ Tabelas:"
    just tables

# Listar todas as tabelas
tables:
    @echo "ğŸ“‹ Tabelas no Banco:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "USE $$MYSQL_DATABASE; SHOW TABLES;"

# Contar registros de todas as tabelas
count:
    @echo "ğŸ”¢ Contagem de Registros:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT table_name AS 'Tabela', table_rows AS 'Registros' FROM information_schema.tables WHERE table_schema = '$$MYSQL_DATABASE' ORDER BY table_rows DESC;"

# Ver tamanho do banco de dados
db-size:
    @echo "ğŸ’¾ Tamanho do Banco de Dados:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "SELECT table_schema AS 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' FROM information_schema.tables WHERE table_schema = '$$MYSQL_DATABASE' GROUP BY table_schema;"

# Ver tamanho de cada tabela
table-sizes:
    @echo "ğŸ“Š Tamanho das Tabelas:"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SELECT table_name AS 'Tabela', ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)' FROM information_schema.TABLES WHERE table_schema = '$$MYSQL_DATABASE' ORDER BY (data_length + index_length) DESC;"

# Descrever estrutura de uma tabela
describe table:
    @echo "ğŸ“‹ Estrutura da Tabela: {{table}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "DESCRIBE {{table}};"

# Ver Ã­ndices de uma tabela
indexes table:
    @echo "ğŸ”‘ Ãndices da Tabela: {{table}}"
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "SHOW INDEXES FROM {{table}};"

# ============================================================================
# ğŸš ACESSO DIRETO
# ============================================================================

# Acesso direto ao MySQL CLI
mysql:
    @echo "ğŸš Acessando MySQL CLI..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE

# Executar query SQL direta
query sql:
    @echo "ğŸ” Executando query..."
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE -e "{{sql}}"

# Acesso ao shell do container app
shell:
    @echo "ğŸš Acessando shell do container..."
    {{_compose}} exec app bash

# Acesso ao shell do container db
db-shell:
    @echo "ğŸš Acessando shell do banco..."
    {{_compose}} exec db bash

# ============================================================================
# ğŸ§ª TESTES
# ============================================================================

# Executar migrations no banco de testes
test-migrate:
    @echo "ğŸ§ª Executando migrations no banco de testes..."
    {{_app}} php artisan migrate --database=testing --force
    @echo "âœ… Migrations de teste concluÃ­das!"

# Resetar banco de testes
test-fresh:
    @echo "ğŸ§ª Resetando banco de testes..."
    {{_app}} php artisan migrate:fresh --database=testing --seed --force
    @echo "âœ… Banco de testes resetado!"

# ============================================================================
# ğŸš€ WORKFLOWS COMPLETOS
# ============================================================================

# Setup inicial completo do banco
setup:
    @echo "ğŸš€ SETUP INICIAL DO BANCO DE DADOS"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    just migrate
    just seed
    just cache-optimize
    @echo ""
    @echo "âœ… Setup concluÃ­do!"
    just status

# Deploy seguro em produÃ§Ã£o
deploy:
    @echo "ğŸš€ DEPLOY EM PRODUÃ‡ÃƒO"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "1. Criando backup..."
    ENV=prod just backup "pre-deploy"
    @echo ""
    @echo "2. Executando migrations..."
    ENV=prod just migrate
    @echo ""
    @echo "3. Otimizando caches..."
    ENV=prod just cache-optimize
    @echo ""
    @echo "âœ… Deploy concluÃ­do!"
    ENV=prod just status

# ManutenÃ§Ã£o completa do banco
maintenance:
    @echo "ğŸ”§ MANUTENÃ‡ÃƒO COMPLETA"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    just backup "pre-maintenance"
    just check
    just analyze
    just optimize
    just cache-optimize
    @echo ""
    @echo "âœ… ManutenÃ§Ã£o concluÃ­da!"
    just db-size

# DiagnÃ³stico completo
diagnose:
    @echo "ğŸ” DIAGNÃ“STICO COMPLETO"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    just info
    @echo ""
    just status
    @echo ""
    just table-sizes
    @echo ""
    just count
    @echo ""
    @echo "âœ… DiagnÃ³stico concluÃ­do!"

# ============================================================================
# ğŸ—‘ï¸ LIMPEZA (PERIGOSO!)
# ============================================================================

# Dropar banco e recriar do zero
nuke:
    @echo "ğŸ’£ ATENÃ‡ÃƒO: DESTRUINDO BANCO DE DADOS!"
    @echo "Ambiente: {{env}}"
    @echo "Isso Ã© IRREVERSÃVEL!"
    @echo ""
    @read -p "Digite 'DESTRUIR' para confirmar: " confirm; \
    if [ "$$confirm" != "DESTRUIR" ]; then \
        echo "âŒ Cancelado!"; exit 1; \
    fi
    @echo ""
    @echo "Ãšltima chance! Pressione Ctrl+C..."
    sleep 5
    {{_db}} mysql -u root -p$$MYSQL_ROOT_PASSWORD -e "DROP DATABASE IF EXISTS $$MYSQL_DATABASE; CREATE DATABASE $$MYSQL_DATABASE;"
    just migrate
    @echo "âœ… Banco recriado do zero!"
